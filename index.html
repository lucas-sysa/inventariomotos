<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventario VIN</title>

<style>
* { box-sizing: border-box; }

body {
  font-family: Arial, Helvetica, sans-serif;
  background: #0f172a;
  color: #fff;
  padding: 16px;
  margin: 0;
}

h2 {
  text-align: center;
  font-size: 22px;
  margin-bottom: 14px;
}

#vin {
  width: 100%;
  padding: 18px;
  font-size: 24px;
  border-radius: 10px;
  border: none;
  outline: none;
  text-align: center;
  font-weight: bold;
  background: #e5e7eb;
  color: #000;
}

#res {
  margin-top: 18px;
  padding: 16px;
  font-size: 20px;
  text-align: center;
  border-radius: 10px;
  font-weight: bold;
}

.ok   { background: #16a34a; }
.warn { background: #f59e0b; color: #000; }
.err  { background: #dc2626; }

.flash { animation: flash 0.12s; }
@keyframes flash {
  from { transform: scale(1.05); }
  to   { transform: scale(1); }
}
</style>
</head>

<body>

<h2>ESCANEAR VIN</h2>

<input
  id="vin"
  autofocus
  inputmode="none"
  autocomplete="off"
  placeholder="ESCANEAR VIN"
>

<div id="res"></div>

<script>
const URL = "https://script.google.com/macros/s/AKfycbwaEEXiNCQ9Mo-lQoZlBvJ8iK5GiVROGN888xyoiBoGYsP802rOTr5rKzUmdUvYU-2dTA/exec";

const vinInput = document.getElementById("vin");
const res = document.getElementById("res");

let enviando = false;

function limpiarInput() {
  vinInput.value = "";
  // fuerza limpieza real en handheld
  setTimeout(() => vinInput.value = "", 0);
}

vinInput.focus();

vinInput.addEventListener("keydown", e => {

  // bloquea cualquier tecla mientras envía
  if (enviando) {
    e.preventDefault();
    return;
  }

  if (e.key === "Enter") {
    e.preventDefault();

    const vin = vinInput.value.trim();
    if (!vin) return;

    enviando = true;
    vinInput.disabled = true;

    // limpia INMEDIATO (antes del fetch)
    limpiarInput();

    fetch(URL, {
      method: "POST",
      body: new URLSearchParams({ vin })
    })
    .then(r => r.json())
    .then(d => {

      if (d.error) {
        res.textContent = d.error;
        res.className = "err flash";
      } else {
        res.textContent = d.resultado;
        res.className =
          d.resultado === "SAP y WMS" ? "ok flash" :
          d.resultado.includes("SOLO") ? "warn flash" :
          "err flash";
      }

    })
    .catch(() => {
      res.textContent = "ERROR DE CONEXIÓN";
      res.className = "err";
    })
    .finally(() => {
      // listo para el próximo piqueo
      limpiarInput();
      vinInput.disabled = false;
      vinInput.focus();
      enviando = false;
    });
  }
});
</script>

</body>
</html>
